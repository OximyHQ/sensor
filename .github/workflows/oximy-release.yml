# Oximy Release Workflow
#
# This workflow builds and releases the Oximy desktop applications for macOS and Windows.
# It uses the unified build-prod.sh script - the same script used for local builds.
#
# Trigger: Manual dispatch with version number input
#
# Required Secrets:
#   macOS:
#     - APPLE_CERTIFICATE: Base64-encoded Developer ID certificate (.p12)
#     - APPLE_CERTIFICATE_PASSWORD: Password for the certificate
#     - APPLE_ID: Apple ID email for notarization
#     - APPLE_APP_PASSWORD: App-specific password for notarization
#     - INSTALLER_CERTIFICATE: Base64-encoded Developer ID Installer certificate (.p12)
#     - INSTALLER_CERTIFICATE_PASSWORD: Password for the installer certificate
#     - INSTALLER_CERT: Developer ID Installer certificate name for PKG signing
#     - BETTERSTACK_ERRORS_DSN: (Optional) Better Stack Errors Sentry-compatible DSN for crash reporting
#     - BETTERSTACK_LOGS_TOKEN: (Optional) Better Stack Logs source token
#     - BETTERSTACK_LOGS_HOST: (Optional) Better Stack Logs ingesting host
#
#   Windows:
#     - (No secrets required for unsigned builds)

name: Oximy Release

on:
  workflow_dispatch:
    inputs:
      version_macos:
        description: 'macOS version to release (e.g. 1.0.1). Leave empty to skip Mac build.'
        required: false
        type: string
        default: ''
      version_windows:
        description: 'Windows version to release (e.g. 1.0.0). Leave empty to skip Windows build.'
        required: false
        type: string
        default: ''
      min_supported:
        description: 'Minimum supported version (bump on breaking changes)'
        required: false
        default: '0.0.3'
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  # ===========================================
  # Preflight — validate version & generate changelog
  # ===========================================
  preflight:
    name: Preflight
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate inputs
        run: |
          if [ -z "${{ inputs.version_macos }}" ] && [ -z "${{ inputs.version_windows }}" ]; then
            echo "::error::At least one of version_macos or version_windows must be provided."
            exit 1
          fi
          echo "macOS version: ${{ inputs.version_macos || '(skipped)' }}"
          echo "Windows version: ${{ inputs.version_windows || '(skipped)' }}"

      - name: Check for duplicate version
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          check_tag() {
            local TAG="$1"
            if git rev-parse "refs/tags/$TAG" >/dev/null 2>&1; then
              echo "::error::Tag $TAG already exists. Use a different version number."
              exit 1
            fi
            if gh release view "$TAG" >/dev/null 2>&1; then
              echo "::error::GitHub release $TAG already exists. Delete it first or use a different version."
              exit 1
            fi
            echo "Tag $TAG is available."
          }
          [ -n "${{ inputs.version_macos }}" ] && check_tag "oximy-mac-v${{ inputs.version_macos }}"
          [ -n "${{ inputs.version_windows }}" ] && check_tag "oximy-win-v${{ inputs.version_windows }}"

      - name: Generate changelog
        id: changelog
        run: |
          # Find the most recent release tag across both platforms
          PREV_TAG=$(git tag --list 'oximy-mac-v*' 'oximy-win-v*' --sort=-v:refname | head -1)

          if [ -z "$PREV_TAG" ]; then
            echo "No previous release tag found — including all commits."
            LOG=$(git log --pretty=format:"- %s (%h)" --no-merges -50)
          else
            echo "Previous release: $PREV_TAG"
            LOG=$(git log "${PREV_TAG}..HEAD" --pretty=format:"- %s (%h)" --no-merges)
          fi

          if [ -z "$LOG" ]; then
            LOG="- No changes since $PREV_TAG"
          fi

          # Write to output (multiline)
          {
            echo "changelog<<CHANGELOG_EOF"
            echo "$LOG"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"

          echo "--- Generated Changelog ---"
          echo "$LOG"

  # ===========================================
  # Build macOS App (Universal Binary: ARM64 + x86_64)
  # ===========================================
  build-macos:
    name: Build macOS
    needs: [preflight]
    if: inputs.version_macos != ''
    runs-on: macos-14
    outputs:
      dmg-name: ${{ steps.build.outputs.dmg-name }}
      pkg-name: ${{ steps.build.outputs.pkg-name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Import code signing certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_CERTIFICATE }}
          p12-password: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}

      - name: Import installer signing certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.INSTALLER_CERTIFICATE }}
          p12-password: ${{ secrets.INSTALLER_CERTIFICATE_PASSWORD }}
          create-keychain: false

      - name: Setup Node.js (for create-dmg)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install create-dmg
        run: npm install -g create-dmg

      - name: Build macOS app
        id: build
        env:
          VERSION: ${{ inputs.version_macos }}
          DEVELOPER_ID: "Developer ID Application: Oximy, Inc. (K6H6LCASRA)"
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          TEAM_ID: "K6H6LCASRA"
          INSTALLER_CERT: ${{ secrets.INSTALLER_CERT }}
          BETTERSTACK_ERRORS_DSN: ${{ secrets.BETTERSTACK_ERRORS_DSN }}
          BETTERSTACK_LOGS_TOKEN: ${{ secrets.BETTERSTACK_LOGS_TOKEN }}
          BETTERSTACK_LOGS_HOST: ${{ secrets.BETTERSTACK_LOGS_HOST }}
        run: |
          chmod +x build-prod.sh
          ./build-prod.sh mac --version "$VERSION"
          echo "dmg-name=Oximy-$VERSION.dmg" >> $GITHUB_OUTPUT
          echo "pkg-name=Oximy-$VERSION.pkg" >> $GITHUB_OUTPUT

      # Note: dSYM upload removed — Better Stack Errors doesn't support symbolication upload.
      # Native crash stack traces will show unsymbolicated addresses.

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: |
            OximyMac/build/Oximy-${{ inputs.version_macos }}.dmg
            OximyMac/build/Oximy-${{ inputs.version_macos }}.pkg
          retention-days: 30

  # ===========================================
  # Build Windows App with Inno Setup Installer
  # ===========================================
  build-windows:
    name: Build Windows
    needs: [preflight]
    if: inputs.version_windows != ''
    runs-on: windows-latest
    outputs:
      setup-name: ${{ steps.build.outputs.setup-name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Validate version format
        run: |
          $version = "${{ inputs.version_windows }}"
          $semverPattern = '^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(-[a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*)?$'
          if ($version -notmatch $semverPattern) {
              Write-Error "Invalid version format: '$version'. Must be SemVer2 (e.g., 1.0.0, 1.2.3-beta.1)"
              exit 1
          }
          Write-Host "Version '$version' is valid"

      - name: Build Windows app
        id: build
        env:
          VERSION: ${{ inputs.version_windows }}
          BETTERSTACK_ERRORS_DSN: ${{ secrets.BETTERSTACK_ERRORS_DSN }}
          BETTERSTACK_LOGS_TOKEN: ${{ secrets.BETTERSTACK_LOGS_TOKEN }}
          BETTERSTACK_LOGS_HOST: ${{ secrets.BETTERSTACK_LOGS_HOST }}
        run: |
          # Use the unified build script via bash (Git Bash on Windows)
          bash -c "./build-prod.sh windows --version $env:VERSION"
          echo "setup-name=OximySetup-${{ inputs.version_windows }}.exe" >> $env:GITHUB_OUTPUT

      - name: Create Inno Setup installer (optional)
        working-directory: OximyWindows
        run: |
          $iss = "installer\OximySetup.iss"
          if (Test-Path $iss) {
            (Get-Content $iss) -replace '#define MyAppVersion ".*"', '#define MyAppVersion "${{ inputs.version_windows }}"' | Set-Content $iss
            $innoPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
            if (Test-Path $innoPath) {
              # Clean output dir first so only one versioned .exe is produced
              Remove-Item -Path "installer\Output\*.exe" -ErrorAction SilentlyContinue
              & $innoPath $iss
            } else {
              Write-Warning "Inno Setup not found, skipping installer creation"
            }
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: OximyWindows/installer/Output/*.exe
          retention-days: 30

  # ===========================================
  # Create GitHub Release
  # ===========================================
  create-release:
    name: Create Release
    needs: [preflight, build-macos, build-windows]
    if: |
      always() &&
      needs.preflight.result == 'success' &&
      (needs.build-macos.result == 'success' || needs.build-windows.result == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download macOS artifacts
        if: needs.build-macos.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: macos-release
          path: release-assets/macos

      - name: Download Windows artifacts
        if: needs.build-windows.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: release-assets/windows

      - name: List release assets
        run: |
          echo "=== macOS ==="
          ls -la release-assets/macos/ || echo "No macOS files"
          echo ""
          echo "=== Windows ==="
          ls -la release-assets/windows/ || echo "No Windows files"

      - name: Create versioned platform release(s)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PRERELEASE_FLAG=""
          [ "${{ inputs.prerelease }}" = "true" ] && PRERELEASE_FLAG="--prerelease"

          # macOS versioned release
          if [ "${{ needs.build-macos.result }}" = "success" ]; then
            MAC_TAG="oximy-mac-v${{ inputs.version_macos }}"
            if gh release view "$MAC_TAG" >/dev/null 2>&1; then
              echo "Release $MAC_TAG already exists — skipping creation (idempotent re-run)"
            else
              cat > /tmp/mac-notes.md << 'NOTES_EOF'
          ## macOS v${{ inputs.version_macos }}

          ### Downloads

          | | |
          |---|---|
          | [Oximy-${{ inputs.version_macos }}.dmg](https://github.com/OximyHQ/sensor/releases/download/oximy-mac-v${{ inputs.version_macos }}/Oximy-${{ inputs.version_macos }}.dmg) | First install |
          | [Oximy-${{ inputs.version_macos }}.pkg](https://github.com/OximyHQ/sensor/releases/download/oximy-mac-v${{ inputs.version_macos }}/Oximy-${{ inputs.version_macos }}.pkg) | Updates & MDM |

          ### What's Changed

          ${{ needs.preflight.outputs.changelog }}

          ### Compatibility
          - **Apple Silicon (M1/M2/M3/M4)**: Native ARM64 binary
          - **Intel Macs**: Native x86_64 binary (Universal Binary)
          NOTES_EOF
              gh release create "$MAC_TAG" \
                --title "Oximy macOS v${{ inputs.version_macos }}" \
                $PRERELEASE_FLAG \
                --notes-file /tmp/mac-notes.md \
                "release-assets/macos/Oximy-${{ inputs.version_macos }}.dmg" \
                "release-assets/macos/Oximy-${{ inputs.version_macos }}.pkg"
              echo "Created macOS release: $MAC_TAG"
            fi
          fi

          # Windows versioned release
          if [ "${{ needs.build-windows.result }}" = "success" ]; then
            WIN_TAG="oximy-win-v${{ inputs.version_windows }}"
            if gh release view "$WIN_TAG" >/dev/null 2>&1; then
              echo "Release $WIN_TAG already exists — skipping creation (idempotent re-run)"
            else
              cat > /tmp/win-notes.md << 'NOTES_EOF'
          ## Windows v${{ inputs.version_windows }}

          ### Downloads

          | | |
          |---|---|
          | [OximySetup-${{ inputs.version_windows }}.exe](https://github.com/OximyHQ/sensor/releases/download/oximy-win-v${{ inputs.version_windows }}/OximySetup-${{ inputs.version_windows }}.exe) | Install & Update |

          ### What's Changed

          ${{ needs.preflight.outputs.changelog }}
          NOTES_EOF
              WIN_EXE=$(ls release-assets/windows/*.exe 2>/dev/null | head -1)
              gh release create "$WIN_TAG" \
                --title "Oximy Windows v${{ inputs.version_windows }}" \
                $PRERELEASE_FLAG \
                --notes-file /tmp/win-notes.md \
                "$WIN_EXE"
              echo "Created Windows release: $WIN_TAG"
            fi
          fi

      - name: Update latest release
        if: ${{ inputs.prerelease == false }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p release-assets/latest

          # Fetch current version.json to preserve the other platform's version
          mkdir -p /tmp/prev-version
          gh release download latest --pattern version.json -D /tmp/prev-version 2>/dev/null || true
          PREV=$(cat /tmp/prev-version/version.json 2>/dev/null || echo '{}')
          LATEST_MAC=$(echo "$PREV" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('latest_macos','0.0.0'))" 2>/dev/null || echo "0.0.0")
          LATEST_WIN=$(echo "$PREV" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('latest_windows','0.0.0'))" 2>/dev/null || echo "0.0.0")

          # Update only the platform(s) built this run
          [ "${{ needs.build-macos.result }}" = "success" ] && LATEST_MAC="${{ inputs.version_macos }}"
          [ "${{ needs.build-windows.result }}" = "success" ] && LATEST_WIN="${{ inputs.version_windows }}"

          # Generate version.json
          cat > release-assets/latest/version.json << VJEOF
          {
            "latest_macos": "${LATEST_MAC}",
            "latest_windows": "${LATEST_WIN}",
            "min_supported": "${{ inputs.min_supported }}",
            "download": {
              "macos": "https://github.com/OximyHQ/sensor/releases/download/latest/Oximy.pkg",
              "windows": "https://github.com/OximyHQ/sensor/releases/download/latest/OximySetup.exe"
            }
          }
          VJEOF

          # Rename platform assets to fixed names for static URLs
          UPLOAD_ASSETS="release-assets/latest/version.json"
          if [ "${{ needs.build-macos.result }}" = "success" ]; then
            cp "release-assets/macos/Oximy-${{ inputs.version_macos }}.dmg" release-assets/latest/Oximy.dmg
            cp "release-assets/macos/Oximy-${{ inputs.version_macos }}.pkg" release-assets/latest/Oximy.pkg
            UPLOAD_ASSETS="$UPLOAD_ASSETS release-assets/latest/Oximy.dmg release-assets/latest/Oximy.pkg"
          fi
          if [ "${{ needs.build-windows.result }}" = "success" ]; then
            WIN_EXE=$(ls release-assets/windows/*.exe 2>/dev/null | head -1)
            if [ -n "$WIN_EXE" ]; then
              cp "$WIN_EXE" release-assets/latest/OximySetup.exe
              UPLOAD_ASSETS="$UPLOAD_ASSETS release-assets/latest/OximySetup.exe"
            fi
          fi

          LATEST_NOTES="This always points to the most recent stable release.

          **macOS**: v${LATEST_MAC} · **Windows**: v${LATEST_WIN}

          ## Download

          | Platform | Link | Use |
          |----------|------|-----|
          | macOS | [Oximy.dmg](https://github.com/OximyHQ/sensor/releases/download/latest/Oximy.dmg) | First install |
          | macOS | [Oximy.pkg](https://github.com/OximyHQ/sensor/releases/download/latest/Oximy.pkg) | Updates & MDM |
          | Windows | [OximySetup.exe](https://github.com/OximyHQ/sensor/releases/download/latest/OximySetup.exe) | Install & Update |

          ## Auto-Update

          Apps check [version.json](https://github.com/OximyHQ/sensor/releases/download/latest/version.json) on startup."

          if gh release view latest >/dev/null 2>&1; then
            # Update existing 'latest' release — upload/replace only the new assets
            # (preserves the other platform's assets already in the release)
            gh release upload latest --clobber $UPLOAD_ASSETS
            gh release edit latest \
              --title "Latest Stable — macOS v${LATEST_MAC} / Windows v${LATEST_WIN}" \
              --notes "$LATEST_NOTES"
          else
            # First-ever 'latest' release — create it
            git tag -f latest
            git push origin latest --force
            gh release create latest \
              --title "Latest Stable — macOS v${LATEST_MAC} / Windows v${LATEST_WIN}" \
              --notes "$LATEST_NOTES" \
              --latest \
              $UPLOAD_ASSETS
          fi

      - name: Summary
        run: |
          echo "## Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release**: ${{ inputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Versioned Releases" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-macos.result }}" = "success" ]; then
            echo "- **macOS** [oximy-mac-v${{ inputs.version_macos }}](https://github.com/OximyHQ/sensor/releases/tag/oximy-mac-v${{ inputs.version_macos }})" >> $GITHUB_STEP_SUMMARY
            echo "  - [Oximy-${{ inputs.version_macos }}.dmg](https://github.com/OximyHQ/sensor/releases/download/oximy-mac-v${{ inputs.version_macos }}/Oximy-${{ inputs.version_macos }}.dmg)" >> $GITHUB_STEP_SUMMARY
            echo "  - [Oximy-${{ inputs.version_macos }}.pkg](https://github.com/OximyHQ/sensor/releases/download/oximy-mac-v${{ inputs.version_macos }}/Oximy-${{ inputs.version_macos }}.pkg)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.build-windows.result }}" = "success" ]; then
            echo "- **Windows** [oximy-win-v${{ inputs.version_windows }}](https://github.com/OximyHQ/sensor/releases/tag/oximy-win-v${{ inputs.version_windows }})" >> $GITHUB_STEP_SUMMARY
            echo "  - [OximySetup-${{ inputs.version_windows }}.exe](https://github.com/OximyHQ/sensor/releases/download/oximy-win-v${{ inputs.version_windows }}/OximySetup-${{ inputs.version_windows }}.exe)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          REPO="${{ github.repository }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TRIGGERED_BY="${{ github.actor }}"

          # Build platform label and release links
          PLATFORMS=""
          RELEASE_LINKS=""
          if [ "${{ needs.build-macos.result }}" = "success" ]; then
            PLATFORMS="macOS v${{ inputs.version_macos }}"
            RELEASE_LINKS=":apple: <https://github.com/${REPO}/releases/tag/oximy-mac-v${{ inputs.version_macos }}|macOS v${{ inputs.version_macos }}>"
          fi
          if [ "${{ needs.build-windows.result }}" = "success" ]; then
            PLATFORMS="${PLATFORMS:+$PLATFORMS · }Windows v${{ inputs.version_windows }}"
            RELEASE_LINKS="${RELEASE_LINKS:+$RELEASE_LINKS · }:window: <https://github.com/${REPO}/releases/tag/oximy-win-v${{ inputs.version_windows }}|Windows v${{ inputs.version_windows }}>"
          fi

          if [ "${{ job.status }}" = "success" ]; then
            COLOR="#22c55e"
            TITLE=":white_check_mark: Sensor release succeeded — ${PLATFORMS}"
            LINKS="${RELEASE_LINKS}\n<https://github.com/${REPO}/releases/tag/latest|latest tag>"
            AUTO_UPDATE="\n:arrows_counterclockwise: *Auto-update:* \`version.json\` updated — running apps will see this on next launch"
          else
            COLOR="#ef4444"
            TITLE=":x: Sensor release failed — ${PLATFORMS}"
            LINKS=":warning: <${RUN_URL}|View build logs>"
            AUTO_UPDATE=""
          fi

          PRERELEASE_TAG=""
          if [ "${{ inputs.prerelease }}" = "true" ]; then
            PRERELEASE_TAG="\n:test_tube: *Pre-release* — not tagged as latest, no auto-update notification"
            AUTO_UPDATE=""
          fi

          curl -sf "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "attachments": [
              {
                "color": "${COLOR}",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*${TITLE}*\n\n:package: *Repo:* \`${REPO}\`\n:bust_in_silhouette: *Triggered by:* ${TRIGGERED_BY}\n${LINKS}${AUTO_UPDATE}${PRERELEASE_TAG}"
                    }
                  }
                ]
              }
            ]
          }
          EOF
